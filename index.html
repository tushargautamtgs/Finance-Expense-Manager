<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Finance Dashboard â€” My Finance Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
          --bg: #f4f6fa;
          --card: #ffffff;
          --muted: #7b8093;
          --accent: #2dd4bf;
          --accent-2: #0ea5e9;
          --danger: #fb7185;
          --text: #0f172a;
          --glass: rgba(255, 255, 255, 0.6);
          --scrollbar-bg: rgba(0, 0, 0, 0.05);
          --scrollbar-thumb: rgba(0, 0, 0, 0.1);
        }
        .dark {
          --bg: #0b1220;
          --card: #0f1724;
          --muted: #97a0b8;
          --accent: #34d399;
          --accent-2: #38bdf8;
          --danger: #fb7185;
          --text: #e6eef8;
          --glass: rgba(255, 255, 255, 0.04);
          --scrollbar-bg: rgba(255, 255, 255, 0.05);
          --scrollbar-thumb: rgba(255, 255, 255, 0.15);
        }
        * {
          box-sizing: border-box;
        }
        body {
          margin: 0;
          font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto,
            "Helvetica Neue", Arial;
          background: var(--bg);
          color: var(--text);
          -webkit-font-smoothing: antialiased;
          transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Animations */
        @keyframes slideUp {
          from {
            opacity: 0;
            transform: translateY(30px);
          }
          to {
            opacity: 1;
            transform: none;
          }
        }
        .animate-slide {
          animation: slideUp 0.7s cubic-bezier(0.6, 0.7, 0, 1.1) both;
        }
        @keyframes scaleIn {
          from {
            opacity: 0;
            transform: scale(0.94);
          }
          to {
            opacity: 1;
            transform: scale(1);
          }
        }
        .animate-scale {
          animation: scaleIn 0.5s cubic-bezier(0.2, 0.8, 0.4, 1) both;
        }
        /* Scrollbar style */
        .sidebar,
        .tableWrap {
          scrollbar-width: thin;
          scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-bg);
        }
        .sidebar::-webkit-scrollbar,
        .tableWrap::-webkit-scrollbar {
          width: 8px;
          height: 8px;
        }
        .sidebar::-webkit-scrollbar-track,
        .tableWrap::-webkit-scrollbar-track {
          background: var(--scrollbar-bg);
          border-radius: 8px;
        }
        .sidebar::-webkit-scrollbar-thumb,
        .tableWrap::-webkit-scrollbar-thumb {
          background-color: var(--scrollbar-thumb);
          border-radius: 8px;
          border: 2px solid var(--scrollbar-bg);
        }
        .app {
          display: grid;
          grid-template-columns: 260px 1fr;
          min-height: 100vh;
          gap: 20px;
          padding: 20px;
          transition: all 0.3s ease;
        }
        @media (max-width: 900px) {
          .app {
            grid-template-columns: 1fr;
            padding: 12px;
          }
          .sidebar {
            display: flex;
            gap: 8px;
            overflow: auto;
          }
        }
        .sidebar {
          background: linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.02),
            rgba(255, 255, 255, 0)
          );
          border-radius: 14px;
          padding: 18px;
          box-shadow: 0 6px 18px rgba(2, 6, 23, 0.08);
          height: calc(100vh - 40px);
          position: sticky;
          top: 20px;
          overflow: auto;
          backdrop-filter: blur(6px);
        }
        .brand {
          display: flex;
          align-items: center;
          gap: 12px;
          margin-bottom: 18px;
        }
        .logo {
          width: 42px;
          height: 42px;
          border-radius: 10px;
          background: linear-gradient(135deg, var(--accent), var(--accent-2));
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: 700;
          cursor: default;
          user-select: none;
        }
        .brand h3 {
          margin: 0;
          font-size: 16px;
          letter-spacing: 0.2px;
          user-select: none;
        }
        .nav {
          margin-top: 8px;
          display: flex;
          flex-direction: column;
          gap: 8px;
        }
        .nav button {
          background: transparent;
          border: none;
          text-align: left;
          padding: 10px 12px;
          border-radius: 8px;
          color: var(--text);
          display: flex;
          align-items: center;
          gap: 10px;
          cursor: pointer;
          font-weight: 600;
          transition: background 0.18s, transform 0.12s;
        }
        .nav button:hover {
          background: var(--glass);
          transform: translateY(-2px);
        }
        .nav button.active {
          background: linear-gradient(90deg, var(--accent), var(--accent-2));
          color: #04202b;
          box-shadow: 0 6px 18px rgba(11, 88, 84, 0.08);
        }
        .main {
          display: flex;
          flex-direction: column;
          gap: 18px;
          min-height: 100vh;
        }
        .topbar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 12px;
          background: var(--card);
          padding: 12px 16px;
          border-radius: 12px;
          box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
        }
        .searchBox {
          display: flex;
          gap: 12px;
          align-items: center;
        }
        .searchBox input {
          border: 1px solid rgba(15, 23, 42, 0.06);
          padding: 10px 12px;
          border-radius: 10px;
          width: 340px;
          background: transparent;
          color: var(--text);
          font-weight: 600;
          transition: border-color 0.3s ease;
        }
        .searchBox input:hover,
        .searchBox input:focus {
          border-color: var(--accent-2);
          outline: none;
        }
        @media (max-width: 900px) {
          .searchBox input {
            width: 140px;
          }
        }
        .profile {
          display: flex;
          align-items: center;
          gap: 12px;
        }
        .avatar {
          width: 40px;
          height: 40px;
          border-radius: 10px;
          background: linear-gradient(135deg, var(--accent-2), var(--accent));
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 700;
          user-select: none;
        }
        /* Button style */
        .btn {
          background: var(--accent);
          color: #04202b;
          padding: 9px 14px;
          border-radius: 10px;
          border: none;
          cursor: pointer;
          font-weight: 700;
          transition: transform 0.12s, box-shadow 0.12s;
          user-select: none;
          font-size: 14px;
        }
        .btn:hover {
          transform: translateY(-3px);
          box-shadow: 0 10px 30px rgba(13, 148, 136, 0.12);
        }
        .grid {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 16px;
        }
        @media (max-width: 1100px) {
          .grid {
            grid-template-columns: repeat(2, 1fr);
          }
        }
        @media (max-width: 700px) {
          .grid {
            grid-template-columns: 1fr;
          }
        }
        .card {
          background: var(--card);
          padding: 16px;
          border-radius: 12px;
          box-shadow: 0 8px 28px rgba(2, 6, 23, 0.05);
          transition: transform 0.18s, box-shadow 0.18s;
          overflow: hidden;
        }
        .card:hover {
          transform: translateY(-6px);
          box-shadow: 0 18px 48px rgba(2, 6, 23, 0.08);
        }
        .card h4 {
          margin: 0 0 8px 0;
          color: var(--muted);
          font-weight: 700;
          user-select: none;
        }
        .value {
          font-size: 24px;
          margin-top: 4px;
          font-weight: 900;
          letter-spacing: 0.015em;
        }
        .trend {
          font-size: 13px;
          color: var(--muted);
          margin-top: 8px;
          display: flex;
          gap: 8px;
          align-items: center;
          font-weight: 600;
        }
        .small {
          font-size: 13px;
          color: var(--muted);
          font-weight: 600;
        }
        .layout {
          display: grid;
          grid-template-columns: 1fr 420px;
          gap: 16px;
        }
        @media (max-width: 1100px) {
          .layout {
            grid-template-columns: 1fr;
          }
        }
        .chartWrap {
          padding: 14px;
          border-radius: 12px;
          background: var(--card);
          box-shadow: 0 4px 12px rgba(2, 6, 23, 0.06);
        }
        .tableWrap {
          padding: 14px;
          border-radius: 12px;
          background: var(--card);
          max-height: 520px;
          overflow: auto;
          box-shadow: 0 4px 12px rgba(2, 6, 23, 0.06);
        }
        table {
          width: 100%;
          border-collapse: collapse;
          min-width: 640px;
          font-size: 14px;
        }
        th,
        td {
          padding: 10px 12px;
          text-align: left;
          border-bottom: 1px solid rgba(15, 23, 42, 0.06);
          color: var(--text);
          font-weight: 600;
          user-select: text;
        }
        th {
          color: var(--muted);
          font-size: 13px;
          text-transform: uppercase;
        }
        tr:hover td {
          background: rgba(0, 0, 0, 0.02);
        }
        .actions button {
          margin-left: 8px;
          padding: 6px 8px;
          border-radius: 8px;
          border: none;
          cursor: pointer;
          font-weight: 700;
          font-size: 12px;
          background: transparent;
          transition: background 0.2s;
          user-select: none;
        }
        .actions button:hover {
          background: var(--danger);
          color: white;
        }
        .pill {
          display: inline-block;
          padding: 6px 10px;
          border-radius: 999px;
          background: rgba(0, 0, 0, 0.05);
          font-weight: 700;
          font-size: 12px;
        }
        /* Style dropdowns like buttons */
        select {
          padding: 8px 12px;
          font-weight: 700;
          border-radius: 10px;
          border: none;
          background: linear-gradient(135deg, var(--accent), var(--accent-2));
          color: #04202b;
          cursor: pointer;
          transition: box-shadow 0.25s ease;
          -webkit-appearance: none;
          -moz-appearance: none;
          appearance: none;
          background-image:
            linear-gradient(45deg, transparent 50%, #04202b 50%),
            linear-gradient(135deg, #04202b 50%, transparent 50%),
            linear-gradient(to right, var(--accent), var(--accent-2));
          background-position:
            calc(100% - 20px) calc(1em + 2px),
            calc(100% - 15px) calc(1em + 2px),
            0 0;
          background-size: 5px 5px, 5px 5px, 100% 100%;
          background-repeat: no-repeat;
        }
        select:hover {
          box-shadow: 0 4px 12px rgba(2, 210, 191, 0.35);
        }
        select:focus {
          outline: none;
          box-shadow: 0 0 8px var(--accent-2);
        }
        /* Modal */
        .modal-backdrop {
          position: fixed;
          inset: 0;
          display: none;
          background: rgba(0, 0, 0, 0.4);
          align-items: center;
          justify-content: center;
          z-index: 40;
        }
        .modal {
          width: 520px;
          max-width: 94%;
          background: var(--card);
          padding: 22px 22px 18px 22px;
          border-radius: 12px;
          box-shadow: 0 18px 60px rgba(2, 6, 23, 0.4);
          transform: translateY(-20px);
          opacity: 0;
          transition: all 0.25s ease;
        }
        .modal.show {
          transform: translateY(0);
          opacity: 1;
        }
        .modal .row {
          display: flex;
          gap: 12px;
          margin-bottom: 14px;
        }
        .modal input,
        .modal select {
          flex: 1;
          padding: 10px 12px;
          border-radius: 8px;
          border: 1px solid rgba(15, 23, 42, 0.12);
          font-weight: 700;
          color: var(--text);
          background: transparent;
          transition: border-color 0.24s ease;
        }
        .modal input:hover,
        .modal select:hover,
        .modal input:focus,
        .modal select:focus {
          border-color: var(--accent-2);
          outline: none;
        }
        /* Small helpers */
        .muted {
          color: var(--muted);
          font-size: 13px;
          user-select: none;
        }
        .right {
          margin-left: auto;
        }
        .center {
          display: flex;
          align-items: center;
          gap: 10px;
        }
        .fadeIn {
          animation: fadeIn 0.45s ease both;
        }
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(6px);
          }
          to {
            opacity: 1;
            transform: none;
          }
        }
        /* Category filter buttons */
        #categoryFilters {
          margin-top: 8px;
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
        }
        #categoryFilters button {
          background: linear-gradient(135deg, var(--accent), var(--accent-2));
          border: none;
          color: #04202b;
          font-weight: 700;
          padding: 8px 14px;
          border-radius: 9999px;
          cursor: pointer;
          user-select: none;
          font-size: 13px;
          transition: background 0.25s ease;
          box-shadow: 0 3px 8px rgba(13, 148, 136, 0.15);
        }
        #categoryFilters button:hover {
          background: linear-gradient(135deg, var(--accent-2), var(--accent));
          box-shadow: 0 6px 12px rgba(13, 180, 158, 0.25);
        }
        #categoryFilters button.active {
          box-shadow: 0 0 10px 2px var(--accent-2);
          background: var(--accent-2);
          color: white;
        }

        /* Chart toggle button */
        #toggleChartsBtn {
          margin-bottom: 8px;
        }

        /* Dark mode toggle slider */
        .toggle-switch {
          position: relative;
          width: 48px;
          height: 26px;
        }
        .toggle-switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: var(--accent);
          transition: 0.4s;
          border-radius: 26px;
          box-shadow: 0 1px 5px rgba(0,0,0,0.3);
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 20px;
          width: 20px;
          left: 3px;
          bottom: 3px;
          background-color: white;
          transition: 0.4s;
          border-radius: 50%;
          box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        input:checked + .slider {
          background: var(--accent-2);
        }
        input:checked + .slider:before {
          transform: translateX(22px);
        }

    </style>
</head>
<body>
<!-- Welcome screen -->
<div
        id="welcomeScreen"
        style="
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      color: white;
      z-index: 999;
      font-size: 2.6rem;
      letter-spacing: 0.05em;
      transition: opacity 0.8s;
    "
>
    <div>
        <h1 style="margin-bottom: 8px; font-size: 2.6rem">ðŸ‘‹ Welcome, Tushar!</h1>
        <div style="font-size: 1.1rem">Your Finance Dashboard is loading...</div>
    </div>
</div>

<div id="root" class="app">
    <aside class="sidebar fadeIn" id="sidebar">
        <div class="brand">
            <div class="logo">MF</div>
            <div>
                <h3>My Finance</h3>
                <div class="muted" style="font-size: 12px">Personal Dashboard</div>
            </div>
        </div>
        <nav class="nav" id="nav">
            <button
                    class="active"
                    data-view="dashboard"
                    onclick="switchView(this)"
            >Dashboard</button
            >
            <button data-view="transactions" onclick="switchView(this)">Transactions</button>
            <button data-view="accounts" onclick="switchView(this)">Accounts</button>
            <button data-view="reports" onclick="switchView(this)">Reports</button>
            <button data-view="settings" onclick="switchView(this)">Settings</button>
        </nav>
        <hr style="margin: 14px 0; opacity: 0.06" />
        <div>
            <div class="muted" style="font-size: 12px; margin-bottom: 8px">
                Quick Actions
            </div>
            <button class="btn" onclick="openModal()">âž• Add Transaction</button>
        </div>
    </aside>
    <main class="main">
        <div class="topbar fadeIn" style="gap:24px;">
            <div class="searchBox">
                <input
                        type="search"
                        id="globalSearch"
                        placeholder="Search transactions, descriptions..."
                        oninput="searchAll()"
                />
            </div>
            <div style="display:flex; align-items:center; gap:24px;">
                <button id="toggleChartsBtn" class="btn" onclick="toggleCharts()">Hide Charts</button>
                <label class="toggle-switch" title="Toggle Dark / Light Mode">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
                <div class="center">
                    <div class="muted right">Hi, <strong>Tushar</strong></div>
                    <div class="avatar">TG</div>
                </div>
            </div>
        </div>

        <section id="view-dashboard" class="view fadeIn">
            <div class="grid animate-slide">
                <div class="card animate-scale">
                    <h4>Total Income</h4>
                    <div class="value" id="cardIncome">â‚¹0</div>
                    <div class="trend"><span class="muted">This month</span></div>
                </div>
                <div class="card animate-scale">
                    <h4>Total Expense</h4>
                    <div class="value" id="cardExpense">â‚¹0</div>
                    <div class="trend"><span class="muted">This month</span></div>
                </div>
                <div class="card animate-scale">
                    <h4>Balance</h4>
                    <div class="value" id="cardBalance">â‚¹0</div>
                    <div class="trend"><span class="muted">Income âˆ’ Expense</span></div>
                </div>
                <div class="card animate-scale">
                    <h4>Total Wealth</h4>
                    <div class="value" id="cardTotalWealth">â‚¹0</div>
                    <div class="trend"><span class="muted">All time balance</span></div>
                </div>
            </div>


            <!-- Category filters -->
            <div id="categoryFilters"></div>
            <div id="chartsContainer">
                <div class="layout" style="margin-top: 12px">
                    <div class="chartWrap card animate-scale">
                        <h4 style="margin-top: 0">Monthly Balance Trend</h4>
                        <canvas id="monthlyChart" height="180"></canvas>
                        <hr style="margin: 12px 0; opacity: 0.06" />
                        <h4 style="margin: 0">Spending by Category</h4>
                        <canvas id="categoryChart" height="160"></canvas>
                    </div>
                    <div class="tableWrap card animate-scale">
                        <div
                                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  gap: 12px;
                  margin-bottom: 8px;
                "
                        >
                            <div>
                                <div class="muted">Transactions</div>
                                <div class="small">Recent transactions & quick actions</div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center">
                                <select id="monthFilter" onchange="displayTransactions()">
                                    <option value="">All months</option>
                                </select>
                                <button class="btn" onclick="openModal()">New</button>
                            </div>
                        </div>
                        <div id="transactionsTableContainer">
                            <table id="transactionsTable">
                                <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Category</th>
                                    <th>Account</th>
                                    <th>Type</th>
                                    <th class="right">Amount</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="transactionsTbody"></tbody>
                            </table>
                        </div>
                        <div
                                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-top: 12px;
                "
                        >
                            <div class="muted" id="tableInfo">0 transactions</div>
                            <div>
                                <button onclick="prevPage()">Prev</button>
                                <span id="pageInfo" style="padding: 0 8px">1</span>
                                <button onclick="nextPage()">Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section id="view-transactions" class="view" style="display: none">
            <div class="card fadeIn">
                <div
                        style="display: flex; justify-content: space-between; align-items: center"
                >
                    <div>
                        <h3 style="margin: 0">All Transactions</h3>
                        <div class="muted">Manage your entries â€” edit, delete, filter</div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center">
                        <input
                                id="txSearch"
                                placeholder="Search description..."
                                oninput="displayTransactions()"
                        />
                        <select id="txMonth" onchange="displayTransactions()">
                            <option value="">All months</option>
                        </select>
                        <button class="btn" onclick="openModal()">Add Transaction</button>
                    </div>
                </div>
            </div>
            <div class="card tableWrap" style="margin-top: 12px">
                <table>
                    <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Account</th>
                        <th>Type</th>
                        <th class="right">Amount</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="txTbody"></tbody>
                </table>
            </div>
        </section>
        <section id="view-accounts" class="view" style="display: none">
            <div class="card fadeIn">
                <h3>Accounts</h3>
                <div class="muted">Cash, Bank, Wallet balances (coming soon)</div>
            </div>
        </section>
        <section id="view-reports" class="view" style="display: none">
            <div class="card fadeIn">
                <h3>Reports</h3>
                <div class="muted">Export &amp; advanced analytics (coming soon)</div>
            </div>
        </section>
        <section id="view-settings" class="view" style="display: none">
            <div class="card fadeIn">
                <h3>Settings</h3>
                <div class="muted">Theme, backup &amp; restore</div>
            </div>
        </section>
    </main>
</div>
<div
        id="modalBackdrop"
        class="modal-backdrop"
        onclick="closeModal(event)"
>
    <div id="modal" class="modal" onclick="event.stopPropagation()">
        <h3 id="modalTitle">Add Transaction</h3>
        <div class="row">
            <input id="m_date" type="date" />
            <select id="m_type">
                <option value="expense">Expense</option>
                <option value="income">Income</option>
            </select>
        </div>
        <div class="row">
            <input id="m_desc" placeholder="Description (e.g., Salary, Rent)" />
            <input id="m_amount" type="number" placeholder="Amount" />
        </div>
        <div class="row">
            <select id="m_category">
                <option value="general">General</option>
                <option value="food">Food</option>
                <option value="rent">Rent</option>
                <option value="shopping">Shopping</option>
                <option value="travel">Travel</option>
                <option value="salary">Salary</option>
            </select>
            <select id="m_account">
                <option value="cash">Cash</option>
                <option value="bank">Bank</option>
                <option value="wallet">Wallet</option>
            </select>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 12px">
            <button
                    onclick="closeModal()"
                    style="background: transparent; padding: 8px 12px; border-radius: 8px"
            >
                Cancel
            </button>
            <button class="btn" onclick="saveTransaction()">Save</button>
        </div>
    </div>
</div>
<script>
    let transactions = JSON.parse(localStorage.getItem("mf_transactions")) || [];
    let editIndex = null;
    let currentPage = 1;
    const PAGE_SIZE = 7;
    let categoryChart = null;
    let monthlyChart = null;
    let currentCategoryFilter = "";

    document.addEventListener("DOMContentLoaded", () => {
      // Welcome screen fade out
      setTimeout(() => {
        const ws = document.getElementById("welcomeScreen");
        ws.style.opacity = 0;
        setTimeout(() => (ws.style.display = "none"), 800);
      }, 1100);

      initMonthFilters();
      initCharts();
      displayCategoryFilters();
      displayTransactions(true);
      displayDashboardCards();

      // dark mode restore & toggle switch init
      const darkToggle = document.getElementById("darkModeToggle");
      if (localStorage.getItem("mf_theme") === "dark") {
        document.body.classList.add("dark");
        darkToggle.checked = true;
      }
      darkToggle.addEventListener("change", () => {
        toggleDark();
      });
    });

    function formatCurrency(n) {
      return "â‚¹" + Number(n || 0).toLocaleString("en-IN", { maximumFractionDigits: 0 });
    }
    function saveToStorage() {
      localStorage.setItem("mf_transactions", JSON.stringify(transactions));
    }
    function switchView(btn) {
      document.querySelectorAll(".nav button").forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      const view = btn.dataset.view;
      document.querySelectorAll(".view").forEach((v) => (v.style.display = "none"));
      document.getElementById("view-" + view).style.display = "block";
    }
    function openModal(defaultDate) {
      editIndex = null;
      currentCategoryFilter = ""; // reset category filter when adding new
      document.getElementById("modalTitle").innerText = "Add Transaction";
      document.getElementById("m_date").value = defaultDate || new Date().toISOString().slice(0, 10);
      document.getElementById("m_type").value = "expense";
      document.getElementById("m_desc").value = "";
      document.getElementById("m_amount").value = "";
      document.getElementById("m_category").value = "general";
      document.getElementById("m_account").value = "cash";
      showModal();
    }
    function showModal() {
      const back = document.getElementById("modalBackdrop");
      back.style.display = "flex";
      setTimeout(() => document.getElementById("modal").classList.add("show"), 10);
    }
    function closeModal(e) {
      if (e && e.type === "click" && e.target.id !== "modalBackdrop") return;
      document.getElementById("modal").classList.remove("show");
      setTimeout(() => (document.getElementById("modalBackdrop").style.display = "none"), 200);
    }
    function editTransaction(idx) {
      const t = transactions[idx];
      editIndex = idx;
      currentCategoryFilter = ""; // reset on edit
      document.getElementById("modalTitle").innerText = "Edit Transaction";
      document.getElementById("m_date").value = t.date;
      document.getElementById("m_type").value = t.type;
      document.getElementById("m_desc").value = t.desc;
      document.getElementById("m_amount").value = t.amount;
      document.getElementById("m_category").value = t.category;
      document.getElementById("m_account").value = t.account;
      showModal();
    }
    function saveTransaction() {
      const date = document.getElementById("m_date").value;
      const type = document.getElementById("m_type").value;
      const desc = document.getElementById("m_desc").value.trim();
      const amount = parseFloat(document.getElementById("m_amount").value || 0);
      const category = document.getElementById("m_category").value;
      const account = document.getElementById("m_account").value;
      if (!date || !desc || !amount || amount <= 0) {
        alert("Please fill valid date, description and amount (amount > 0)");
        return;
      }
      const tx = { date, type, desc, amount, category, account };
      if (editIndex !== null) {
        transactions[editIndex] = tx;
        editIndex = null;
      } else {
        transactions.unshift(tx); // newest first
      }
      saveToStorage();
      closeModal();
      displayTransactions(true);
      displayDashboardCards();
      displayCategoryFilters();
    }
    function deleteTx(idx) {
      if (!confirm("Delete this transaction?")) return;
      transactions.splice(idx, 1);
      saveToStorage();
      displayTransactions();
      displayDashboardCards();
      displayCategoryFilters();
    }
    function initMonthFilters() {
      const months = Array.from(new Set(transactions.map((t) => t.date.slice(0, 7)))).sort().reverse();
      const monthFilter = document.getElementById("monthFilter");
      const txMonth = document.getElementById("txMonth");
      [monthFilter, txMonth].forEach((s) => {
        s.innerHTML = '<option value="">All months</option>';
        months.forEach((m) => {
          const opt = document.createElement("option");
          opt.value = m;
          opt.text = m;
          s.appendChild(opt);
        });
      });
    }
    function displayCategoryFilters() {
      const categories = [
        ...new Set(
          transactions
            .filter((t) => t.type === "expense")
            .map((t) => t.category)
        ),
      ];
      const container = document.getElementById("categoryFilters");
      container.innerHTML = "";
      const allBtn = document.createElement("button");
      allBtn.textContent = "All";
      allBtn.classList.add(currentCategoryFilter === "" ? "active" : "");
      allBtn.onclick = () => {
        currentCategoryFilter = "";
        displayTransactions(true);
        displayCategoryFilters();
      };
      container.appendChild(allBtn);
      categories.forEach((cat) => {
        const btn = document.createElement("button");
        btn.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
        btn.classList.add(currentCategoryFilter === cat ? "active" : "");
        btn.onclick = () => {
          currentCategoryFilter = cat;
          displayTransactions(true);
          displayCategoryFilters();
        };
        container.appendChild(btn);
      });
    }
    function displayTransactions(resetPage = false) {
      if (resetPage) currentPage = 1;
      initMonthFilters();
      const tb = document.getElementById("transactionsTbody");
      const txTbody = document.getElementById("txTbody");
      const search =
        (document.getElementById("txSearch")?.value || document.getElementById("globalSearch").value || "").toLowerCase();
      const month =
        document.getElementById("monthFilter")?.value ||
        document.getElementById("txMonth")?.value ||
        "";
      let filtered = transactions.filter((t) => {
        if (month && !t.date.startsWith(month)) return false;
        if (
          search &&
          !(
            t.desc.toLowerCase().includes(search) ||
            t.category.toLowerCase().includes(search)
          )
        )
          return false;
        if (currentCategoryFilter && t.category !== currentCategoryFilter) return false;
        return true;
      });
      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if (currentPage > pages) currentPage = pages;
      const start = (currentPage - 1) * PAGE_SIZE;
      const paged = filtered.slice(start, start + PAGE_SIZE);
      tb.innerHTML = "";
      paged.forEach((t, idx) => {
        const globalIdx = transactions.indexOf(filtered[start + idx]);
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${t.date}</td>
          <td>${escapeHtml(t.desc)}</td>
          <td>${t.category}</td>
          <td>${t.account}</td>
          <td>${t.type}</td>
          <td style="text-align:right"><strong>${formatCurrency(t.amount)}</strong></td>
          <td class="actions">
            <button onclick="editTransaction(${globalIdx})">Edit</button>
            <button onclick="deleteTx(${globalIdx})" style="background:transparent; color:var(--danger)">Delete</button>
          </td>`;
        tb.appendChild(row);
      });
      if (txTbody) {
        txTbody.innerHTML = "";
        filtered.forEach((t, idx) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${t.date}</td>
            <td>${escapeHtml(t.desc)}</td>
            <td>${t.category}</td>
            <td>${t.account}</td>
            <td>${t.type}</td>
            <td style="text-align:right"><strong>${formatCurrency(t.amount)}</strong></td>
            <td class="actions">
              <button onclick="editTransaction(${idx})">Edit</button>
              <button onclick="deleteTx(${idx})" style="background:transparent; color:var(--danger)">Delete</button>
            </td>`;
          txTbody.appendChild(row);
        });
      }
      document.getElementById("tableInfo").innerText = `${total} transaction${total !== 1 ? "s" : ""}`;
      document.getElementById("pageInfo").innerText = `${currentPage} / ${pages}`;
      updateCharts();
      displayDashboardCards();
    }
    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        displayTransactions();
      }
    }
    function nextPage() {
      currentPage++;
      displayTransactions();
    }
    function displayDashboardCards() {
      const monthNow = new Date().toISOString().slice(0, 7);
      let income = 0,
        expense = 0;
      transactions.forEach((t) => {
        if (t.type === "income" && t.date.startsWith(monthNow)) income += t.amount;
        if (t.type === "expense" && t.date.startsWith(monthNow)) expense += t.amount;
      });
      document.getElementById("cardIncome").innerText = formatCurrency(income);
      document.getElementById("cardExpense").innerText = formatCurrency(expense);
      document.getElementById("cardBalance").innerText = formatCurrency(income - expense);
    }
    function initCharts() {
      const ctx1 = document.getElementById("categoryChart").getContext("2d");
      const ctx2 = document.getElementById("monthlyChart").getContext("2d");
      categoryChart = new Chart(ctx1, {
        type: "pie",
        data: { labels: [], datasets: [{ data: [], backgroundColor: [
          '#60a5fa','#34d399','#fbbf24','#fb7185','#a78bfa','#f97316','#f59e0b','#10b981','#3b82f6'
        ] }] },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } },
          animation: { duration: 600, easing: "easeOutCubic" },
        },
      });
      monthlyChart = new Chart(ctx2, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Net (Income - Expense)",
              data: [],
              borderColor: "#06b6d4",
              tension: 0.3,
              fill: true,
              backgroundColor: "rgba(6,182,212,0.08)",
              pointRadius: 5,
              pointHoverRadius: 7,
              borderWidth: 3,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { x: { display: true }, y: { display: true, beginAtZero: true } },
          interaction: { mode: "nearest", intersect: false },
          animation: { duration: 700, easing: "easeOutQuart" },
        },
      });
      updateCharts();
    }
    function updateCharts() {
      const catTotals = {};
      const monthlyMap = {};
      transactions.forEach((t) => {
        if (t.type === "expense") catTotals[t.category] = (catTotals[t.category] || 0) + t.amount;
        const m = t.date.slice(0, 7);
        monthlyMap[m] = monthlyMap[m] || 0;
        monthlyMap[m] += t.type === "income" ? t.amount : -t.amount;
      });
      const catLabels = Object.keys(catTotals);
      categoryChart.data.labels = catLabels;
      categoryChart.data.datasets[0].data = catLabels.map((l) => catTotals[l]);
      categoryChart.update();
      const months = Object.keys(monthlyMap).sort();
      monthlyChart.data.labels = months;
      monthlyChart.data.datasets[0].data = months.map((m) => monthlyMap[m]);
      monthlyChart.update();
    }
    function searchAll() {
      displayTransactions(true);
    }
    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, (c) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      }[c]));
    }
    function toggleDark() {
      document.body.classList.toggle("dark");
      localStorage.setItem(
        "mf_theme",
        document.body.classList.contains("dark") ? "dark" : "light"
      );
    }
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape")
        closeModal({ type: "click", target: { id: "modalBackdrop" } });
    });

    // Chart toggle
    function toggleCharts() {
      const chartsContainer = document.getElementById("chartsContainer");
      const toggleBtn = document.getElementById("toggleChartsBtn");
      if (chartsContainer.style.display === "none") {
        chartsContainer.style.display = "grid"; // match layout display style
        toggleBtn.textContent = "Hide Charts";
      } else {
        chartsContainer.style.display = "none";
        toggleBtn.textContent = "Show Charts";
      }
    }

    function displayDashboardCards() {
  // current month income/expense/balance
  const monthNow = new Date().toISOString().slice(0, 7);
  let income = 0,
      expense = 0;
  transactions.forEach(t => {
    if(t.type === "income" && t.date.startsWith(monthNow)) income += t.amount;
    if(t.type === "expense" && t.date.startsWith(monthNow)) expense += t.amount;
  });

  document.getElementById("cardIncome").innerText = formatCurrency(income);
  document.getElementById("cardExpense").innerText = formatCurrency(expense);
  document.getElementById("cardBalance").innerText = formatCurrency(income - expense);

  // all time total wealth calculation
  let totalIncome = 0,
      totalExpense = 0;
  transactions.forEach(t => {
    if(t.type === "income") totalIncome += t.amount;
    if(t.type === "expense") totalExpense += t.amount;
  });
  document.getElementById("cardTotalWealth").innerText = formatCurrency(totalIncome - totalExpense);

  // funds distribution (account-wise balances)
  displayFundsDistribution();
}

    document.addEventListener("DOMContentLoaded", () => {
  // Welcome screen fade out
  setTimeout(() => {
    const ws = document.getElementById("welcomeScreen");
    ws.style.opacity = 0;
    setTimeout(() => (ws.style.display = "none"), 800);
  }, 1100);

  // Restore month filter and theme before displaying anything
  const savedMonth = localStorage.getItem("mf_month_filter") || "";
  const monthFilter = document.getElementById("monthFilter");
  if (monthFilter) monthFilter.value = savedMonth;

  // Theme restore
  const darkToggle = document.getElementById("darkModeToggle");
  const savedTheme = localStorage.getItem("mf_theme") || "light";
  if (savedTheme === "dark") {
    document.body.classList.add("dark");
    darkToggle.checked = true;
  } else {
    document.body.classList.remove("dark");
    darkToggle.checked = false;
  }

  // Add event listeners
  darkToggle.addEventListener("change", () => {
    toggleDark();
  });
  if (monthFilter) {
    monthFilter.addEventListener("change", () => {
      localStorage.setItem("mf_month_filter", monthFilter.value);
      displayTransactions(true);
      displayDashboardCards();
    });
  }

  initMonthFilters();
  initCharts();
  displayCategoryFilters();
  displayTransactions(true);
  displayDashboardCards();
});

function toggleDark() {
  if (document.body.classList.contains("dark")) {
    document.body.classList.remove("dark");
    localStorage.setItem("mf_theme", "light");
  } else {
    document.body.classList.add("dark");
    localStorage.setItem("mf_theme", "dark");
  }
}

// Modify displayDashboardCards() to use month filter currently selected
function displayDashboardCards() {
  const monthFilter = document.getElementById("monthFilter");
  const monthNow = monthFilter && monthFilter.value ? monthFilter.value : new Date().toISOString().slice(0,7);
  let income = 0, expense = 0;
  transactions.forEach(t => {
    if(t.type === "income" && (monthFilter && monthFilter.value ? t.date.startsWith(monthFilter.value) : t.date.startsWith(monthNow))) income += t.amount;
    if(t.type === "expense" && (monthFilter && monthFilter.value ? t.date.startsWith(monthFilter.value) : t.date.startsWith(monthNow))) expense += t.amount;
  });

  document.getElementById("cardIncome").innerText = formatCurrency(income);
  document.getElementById("cardExpense").innerText = formatCurrency(expense);
  document.getElementById("cardBalance").innerText = formatCurrency(income - expense);

  // For Total Wealth and Funds Distribution, use all transactions (no filter)
  let totalIncome = 0, totalExpense = 0;
  transactions.forEach(t => {
    if(t.type === "income") totalIncome += t.amount;
    if(t.type === "expense") totalExpense += t.amount;
  });
  document.getElementById("cardTotalWealth").innerText = formatCurrency(totalIncome - totalExpense);

  displayFundsDistribution();
}


</script>
</body>
</html>
